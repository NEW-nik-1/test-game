<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VK Mini App IPTV/Radio/Games</title>

  <!-- VK Bridge и HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.1/dist/hls.min.js"></script>
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

  <style>
    /* Фон замощен картинкой */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80') center center fixed;
      background-size: cover;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Градиент для шапки */
    header {
      display: flex;
      justify-content: center;
      gap: 15px;
      background: linear-gradient(90deg, #000000cc, #555555cc);
      padding: 10px;
      z-index: 1000;
      user-select: none;
    }
    /* Кнопки */
    header button {
      background: linear-gradient(180deg, #222, #444);
      border: 1px solid #888;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      padding: 10px 20px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      filter: brightness(60%);
    }
    header button.active {
      filter: brightness(100%);
      background: linear-gradient(180deg, #666, #bbb);
      color: black;
      border-color: #eee;
    }
    header button.recording {
      background: red !important;
      color: white !important;
      filter: none !important;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      padding: 15px;
      overflow: hidden;
      position: relative;
    }

    /* Видео плеер с каналами */
    #tv-section {
      display: none;
      flex-direction: column;
      width: 720px;
      max-height: 80vh;
      color: white;
      user-select: none;
    }
    #video-player {
      width: 100%;
      height: 360px;
      background: black;
      border-radius: 8px;
      outline: none;
    }

    #channels-list {
      margin-top: 8px;
      flex: 1;
      overflow-y: auto;
      border: 1.5px solid #555;
      border-radius: 6px;
      background: #111a;
      padding: 10px 0;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
    }

    /* Заголовки Музыка и Кино */
    .category-label {
      width: 100%;
      border: 2px solid #777;
      margin: 8px 0 4px 0;
      text-align: center;
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 2px;
      padding: 3px 0;
      color: #ddd;
      user-select: none;
    }
    .category-label.music {
      border-color: #1e90ff;
      color: #1e90ff;
    }
    .category-label.movies {
      border-color: #ff6347;
      color: #ff6347;
    }

    #channels-list .channel-item {
      width: 90%;
      padding: 6px 10px;
      margin: 2px 0;
      background: transparent;
      border-radius: 4px;
      text-align: left;
      cursor: pointer;
      transition: background-color 0.2s ease;
      color: #ccc;
      font-size: 14px;
      user-select: none;
    }
    #channels-list .channel-item:hover {
      background-color: #4448;
    }
    #channels-list .channel-item.active {
      background-color: #1e90ffaa;
      color: white;
      font-weight: 700;
    }

    /* Радио плеер */
    #radio-section {
      display: none;
      flex-direction: column;
      width: 350px;
      max-height: 80vh;
      user-select: none;
    }
    #audio-player {
      width: 100%;
      height: 40px;
      outline: none;
      border-radius: 8px;
      background: #000a;
      margin-bottom: 8px;
    }
    #radio-list {
      flex: 1;
      overflow-y: auto;
      border: 1.5px solid #555;
      border-radius: 6px;
      background: #111a;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
      font-weight: 600;
      font-size: 14px;
      color: #ccc;
    }
    #radio-list .radio-item {
      width: 90%;
      padding: 6px 10px;
      margin: 2px 0;
      background: transparent;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    #radio-list .radio-item:hover {
      background-color: #4448;
    }
    #radio-list .radio-item.active {
      background-color: #888888aa;
      font-weight: 700;
      color: white;
    }

    /* Игры */
    #games-section {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90vw;
      max-width: 960px;
      max-height: 80vh;
      background: linear-gradient(135deg, #444, #222);
      border-radius: 12px;
      box-shadow: 0 0 20px #000a;
      display: flex;
      flex-direction: column;
      user-select: none;
      z-index: 1500;
    }
    #games-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, #000, #222);
      padding: 8px 12px;
      border-bottom: 1px solid #555;
      color: #ddd;
      font-weight: 700;
      font-size: 18px;
    }
    #games-close {
      cursor: pointer;
      font-size: 24px;
      color: #eee;
      user-select: none;
    }
    #games-list {
      overflow-y: auto;
      flex: 1;
      padding: 8px;
      background: #111a;
      color: #ccc;
    }
    #games-list .game-item {
      padding: 12px 18px;
      margin: 6px 0;
      border-radius: 8px;
      cursor: pointer;
      background: transparent;
      font-size: 16px;
      color: #ccc;
      user-select: none;
      transition: background-color 0.2s ease;
      text-align: center;
    }
    #games-list .game-item:hover {
      background-color: #555;
      color: white;
    }

    /* Окно игры */
    #game-window {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90vw;
      max-width: 980px;
      max-height: 90vh;
      background: black;
      border-radius: 10px;
      box-shadow: 0 0 15px #000;
      z-index: 1600;
      display: flex;
      flex-direction: column;
    }
    #game-controls {
      flex-shrink: 0;
      background: linear-gradient(90deg, #222, #000);
      color: white;
      font-weight: 600;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 6px 12px;
      border-bottom: 1px solid #444;
      user-select: none;
    }
    #game-controls button {
      background: transparent;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: color 0.3s;
      padding: 0 8px;
      line-height: 1;
    }
    #game-controls button:hover {
      color: #1e90ff;
    }
    #game-iframe {
      flex: 1;
      border: none;
      border-radius: 0 0 10px 10px;
      width: 100%;
      height: 100%;
      outline: none;
      background: black;
    }

    /* Тень/затемнение фона за игровым окном */
    #game-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1550;
      display: none;
    }

    /* Нижний правый мелкий текст */
    #footer-note {
      position: fixed;
      right: 8px;
      bottom: 6px;
      font-size: 10px;
      color: #ccc;
      user-select: none;
      z-index: 2000;
      font-family: monospace;
      text-shadow: 0 0 3px #0008;
    }

    /* Скроллы */
    #channels-list::-webkit-scrollbar,
    #radio-list::-webkit-scrollbar,
    #games-list::-webkit-scrollbar {
      width: 8px;
    }
    #channels-list::-webkit-scrollbar-thumb,
    #radio-list::-webkit-scrollbar-thumb,
    #games-list::-webkit-scrollbar-thumb {
      background-color: #666a;
      border-radius: 4px;
    }

  </style>
</head>
<body>
  <header>
    <button id="btn-tv" type="button">ТВ</button>
    <button id="btn-radio" type="button">РАДИО</button>
    <button id="btn-games" type="button">ИГРЫ</button>
  </header>

  <main>
    <!-- ТВ секция -->
    <section id="tv-section" aria-label="ТВ Плеер с каналами">
      <video id="video-player" controls muted playsinline></video>
      <div id="channels-list" aria-label="Список ТВ каналов"></div>
    </section>

    <!-- Радио секция -->
    <section id="radio-section" aria-label="Радио плеер с каналами">
      <audio id="audio-player" controls></audio>
      <div id="radio-list" aria-label="Список радиостанций"></div>
    </section>
  </main>

  <!-- Игры -->
  <section id="games-section" aria-label="Меню игр">
    <div id="games-header">
      <span>Выберите игру</span>
      <span id="games-close" title="Закрыть меню игр" role="button" tabindex="0" aria-label="Закрыть меню игр">✖</span>
    </div>
    <div id="games-list"></div>
  </section>

  <!-- Игровое окно -->
  <div id="game-overlay"></div>
  <div id="game-window" role="dialog" aria-modal="true" aria-label="Игровое окно">
    <div id="game-controls">
      <button id="game-minimize" title="Опустить окно игры" aria-label="Опустить окно игры">▽</button>
      <button id="game-restore" title="Вернуть окно игры" aria-label="Вернуть окно игры" style="display:none;">△</button>
      <button id="game-fullscreen" title="Открыть игру на весь экран" aria-label="Полноэкранный режим">❏</button>
      <button id="game-exit-fullscreen" title="Выйти из полноэкранного режима" aria-label="Выйти из полноэкранного режима" style="display:none;">❏</button>
      <button id="game-close" title="Закрыть игру" aria-label="Закрыть игру">✖</button>
    </div>
    <iframe id="game-iframe" sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-popups" mozallowfullscreen webkitallowfullscreen allowfullscreen></iframe>
  </div>

  <footer id="footer-note">Проект сделан, придуман ?</footer>

  <script>
    //----------------------------------
    // Инициализация VK Bridge
    vkBridge.send('VKWebAppInit').catch(() => {
      // Игнорируем ошибку при запуске вне VK
    });

    // ------ Переменные и элементы --------
    const btnTv = document.getElementById('btn-tv');
    const btnRadio = document.getElementById('btn-radio');
    const btnGames = document.getElementById('btn-games');

    const tvSection = document.getElementById('tv-section');
    const videoPlayer = document.getElementById('video-player');
    const channelsList = document.getElementById('channels-list');

    const radioSection = document.getElementById('radio-section');
    const audioPlayer = document.getElementById('audio-player');
    const radioList = document.getElementById('radio-list');

    const gamesSection = document.getElementById('games-section');
    const gamesClose = document.getElementById('games-close');
    const gamesList = document.getElementById('games-list');

    const gameOverlay = document.getElementById('game-overlay');
    const gameWindow = document.getElementById('game-window');
    const gameIframe = document.getElementById('game-iframe');

    const gameMinimize = document.getElementById('game-minimize');
    const gameRestore = document.getElementById('game-restore');
    const gameFullscreen = document.getElementById('game-fullscreen');
    const gameExitFullscreen = document.getElementById('game-exit-fullscreen');
    const gameClose = document.getElementById('game-close');

    // Состояния
    let hls = null;
    let recording = false;
    let mediaRecorder = null;
    let recordedChunks = [];

    // ---------------------------------
    // Каналы ТВ

    const musicChannels = [
      { name: "Retro TV", url: "http://stream.mediawork.cz/retrotv/retrotvHQ1/playlist.m3u8" },
      { name: "RU TV", url: "https://hls-03-video.webcaramba.com/rutv/live_480/index.m3u8" },
      { name: "Ptica 1", url: "http://streamer.rtcommufa.ru:1935/ptica/ptica1/playlist.m3u8" },
      { name: "Strana FM HD", url: "http://live.stranafm.cdnvideo.ru/stranafm/stranafm_hd.sdp/playlist.m3u8" },
      { name: "TNT High", url: "http://tntmsmotr.mediacdn.ru/cdn/smotr/playlist_hdhigh.m3u8" },
      { name: "Shanson TV", url: "https://hls-shansontv.cdnvideo.ru/shansontv/shansontv-sd.smil/playlist.m3u8" },
      { name: "Chanson ABR", url: "http://chanson-video.hostingradio.ru:8080/hls/chansonabr/live.m3u8" },
      { name: "V2Beat", url: "http://de1se01.v2beat.live/playlist.m3u8" },
      { name: "Video Tour", url: "http://k4.usastreams.com/videotour/videotour/playlist.m3u8" },
      { name: "PlayTV", url: "http://connectiktv.ddns.net:5000/playtv/@playtv/chunklist.m3u8" },
      { name: "Qmusic NL", url: "https://dpp-qmusicnl-live.akamaized.net/streamx/QmusicNL.m3u8" },
      { name: "Kronehit", url: "http://bitcdn-kronehit.bitmovin.com/v2/hls/chunklist_b1628000.m3u8" },
      { name: "Company TV", url: "https://company.fluid.stream/CompanyTV/smil:Company_ALL.smil/playlist_slita.m3u8" }
    ];

    const movieChannels = [
      { name: "Nika TV", url: "http://live-nikatv.cdnvideo.ru/nikatv/nikatv.sdp/playlist.m3u8" },
      { name: "TV 3", url: "https://zabava-htlive.cdn.ngenix.net/hls/CH_TV3/variant.m3u8" },
      { name: "DOVERIE", url: "http://rt-mos-htlive.cdn.ngenix.net/hls/CH_R04_DOVERIE/variant.m3u8" },
      { name: "Kino24Ru", url: "https://sirius.greenhosting.ru/Kino24Ru/video.m3u8" },
      { name: "Bestseller", url: "http://195.245.99.242/Bestseler/playlist.m3u8" },
      { name: "Detectiv", url: "http://195.245.99.242/Detectiv/playlist.m3u8" },
      { name: "Prosveschenie", url: "http://cdn-01.bonus-tv.ru/prosveschenie_edge/tracks-v1a1/index.m3u8" },
      { name: "Astrakhan24", url: "https://streaming.astrakhan.ru/astrakhan24/playlist.m3u8" },
      { name: "NAT Volga HD", url: "http://tele2dvrnat01-02.cdnvideo.ru/stream/NAT_Volga/hls/1920x1080@4504/playlist.m3u8" },
      { name: "Gubernia TV", url: "http://live.guberniatv.cdnvideo.ru/guberniatv/guberniatv.sdp/playlist.m3u8" },
      { name: "Enisey TV", url: "https://hls-eniseytv.cdnvideo.ru/eniseytv/stream1/playlist.m3u8" },
      { name: "NAT Tambov HD", url: "http://tele2dvrnat01-02.cdnvideo.ru/stream/NAT_Tambov/hls/1280x720@2500/playlist.m3u8" },
      { name: "Svoe TV HD", url: "https://svoetv.mediacdn.ru/cdn/svoetv/playlist_hdhigh.m3u8" }
    ];

    // Радио каналы (названия и URL)
    const radioChannels = [
      { name: "Дорожное радио", url: "https://dorognoe.hostingradio.ru/radio" },
      { name: "Радио СИТИ", url: "https://online2.100i6fm.ru/city" },
      { name: "Авторадио", url: "https://pub0101.101.ru/stream/air/aac/64/100" },
      { name: "Радио Рекорд", url: "https://radiorecord.hostingradio.ru/rr_main96.aacp" },
      { name: "Новое радио", url: "https://stream.newradio.ru/novoe96.aacp" },
      { name: "Ретро ФМ", url: "https://retro.hostingradio.ru:8043/retro256.mp3" },
      { name: "Радио Energy", url: "https://pub0202.101.ru:8443/stream/air/aac/64/99" },
      { name: "Европа плюс", url: "https://ep256.hostingradio.ru:8052/europaplus256.mp3" },
      { name: "Наше радио", url: "https://nashe1.hostingradio.ru/nashe-256" },
      { name: "BEST DEEP FM", url: "https://myradio24.org/5129" },
      { name: "Русское радио", url: "https://rusradio.hostingradio.ru/rusradio96.aacp" },
      { name: "Маруся ФМ", url: "https://radio-holding.ru:9433/marusya_default" },
      { name: "Ретро Хит", url: "https://retro.amgradio.ru/Retro?r_bells" },
      { name: "Donat FM Шансон", url: "https://c6.radioboss.fm:18096/stream" },
      { name: "Шансон Радио", url: "https://listen7.myradio24.com/75853" },
      { name: "Extreme Deep House Radio", url: "https://whsh4u-panel.com/proxy/yfryujzw?mp=/stream" },
      { name: "Русская Волна", url: "https://ru.amgradio.ru/RuWave48?r_bells" },
      { name: "Радио Советская эстрада", url: "https://evcast.mediacp.eu:2075/stream" },
      { name: "Retro FM", url: "https://live.retrofm.lv/retrofmlatvia" },
      { name: "Юмор FM", url: "https://pub0302.101.ru:8443/stream/air/aac/64/102" },
      { name: "Record Megamix", url: "https://radiorecord.hostingradio.ru/mix96.aacp" },
      { name: "Радио Любимые хиты", url: "https://myradio24.org/78185" },
      { name: "Мурка FM", url: "https://murka.amgradio.ru/MurkaFM?r_bells" },
      { name: "Relax FM Chillout", url: "https://pub0302.101.ru:8000/stream/trust/mp3/128/24?" },
      { name: "Nu Euphoria Trance Radio", url: "https://radiopotok2.online/http://radio.nueuphoria.com:8000/live" },
      { name: "Ночное такси", url: "https://radiont.shansonspb.ru:1040/stream" },
      { name: "Родные Песни", url: "https://rodpesni.amgradio.ru/rp?r_bells" },
      { name: "Радио Движуха", url: "https://myradio24.org/78805" },
      { name: "Дискотека 80-90", url: "https://myradio24.org/dance80" },
      { name: "Remix FM", url: "https://rmx.amgradio.ru/RemixFM?r_bells" },
      { name: "Хит FM 90е", url: "https://hitfm-hit1990.hostingradio.ru/hit199096.aacp" },
      { name: "DFM Дискач 90-ых", url: "https://dfm-disc90.hostingradio.ru/disc9096.aacp" },
      { name: "Авторадио Дискотека 90-х", url: "https://pub0201.101.ru/stream/pro/aac/64/74?" },
      { name: "90s Eurodance", url: "https://listen1.myradio24.com/5967" },
      { name: "PRO Dj Radio", url: "https://live.prodjradio.net:8065/radio" },
      { name: "Radio Danz", url: "https://streamssl.radiodanz.com/live" },
      { name: "Радио Кавказ-Хит", url: "https://kavkazhit.hostingradio.ru:8017/kavkazhit96.mp3" },
      { name: "Радио Бобина", url: "https://bobina.su" },
      { name: "Авторадио Дискотека 80-х", url: "https://pub0101.101.ru/stream/pro/aac/64/1?" },
      { name: "Дискотека 90-ых", url: "https://pub0302.101.ru:8443/stream/pro/aac/64/74" },
      { name: "Russian Dance", url: "https://pub0302.101.ru:8443/stream/trust/mp3/128/17" },
      { name: "Хит FM Стопудовый Хит", url: "https://hitfm-hit100pud.hostingradio.ru/hit100pud96.aacp" },
      { name: "Record Russian Gold", url: "https://radiorecord.hostingradio.ru/russiangold96.aacp" },
      { name: "Супердискотека 90-х", url: "https://radiorecord.hostingradio.ru/sd9096.aacp" },
      { name: "Русский шансон 24", url: "https://stream.vyshka24.ru/russhanson24" },
      { name: "Радио Калина Красная", url: "https://icecast-studio21.cdnvideo.ru/KalynaK_1a" },
      { name: "Милицейская волна", url: "https://radiomv.hostingradio.ru:80/radiomv128.mp3" },
      { name: "Джем FM", url: "https://online2.jamfm.ru/jam_aacplus" },
      { name: "Радио Музыкальный рай", url: "https://listen7.myradio24.com/96203" },
      { name: "Record Eurodance", url: "https://radiorecord.hostingradio.ru/eurodance96.aacp" },
      { name: "Россия 90-ых", url: "https://pub0102.101.ru:8443/stream/pro/aac/64/33" },
      { name: "Sector Geny / 80s", url: "https://radiopotok2.online/http://89.223.45.5:8000/geny-160" },
      { name: "Авторадио Дискотека СССР", url: "https://pub0302.101.ru:8000/stream/pro/aac/64/144?" },
      { name: "Диско-радио SOVA", url: "https://evcast.mediacp.eu:1965/stream" }
    ];

    // Игры
    const gamesListData = [
      { name: "Gary's World", url: "https://html5.gamemonetize.co/dd5rs8etri5hw51g32sk69qfdoov5tq2/" },
      { name: "crazy-ball-adventures", url: "https://www.onlinegames.io/games/2021/unity2/crazy-ball-adventures/index.html" },
      { name: "subway-horror-chapter", url: "https://www.gamenora.com/embed/subway-horror-chapter-1" },
      { name: "A Difficult Game About Climbing", url: "https://www.gamenora.com/embed/a-difficult-game-about-climbing" },
      { name: "cross-the-road", url: "https://www.onlinegames.io/games/2023/unity/cross-the-road/index.html" },
      { name: "motorcycle racer", url: "https://s3.eponesh.com/games/8866/" },
      { name: "Moto Rider GO", url: "https://app-165758.games.s3.yandex.net/165758/ghtg4xyuxt09og6gtji0jcl6aw8el4w4/index.html" },
      { name: "motorbike-traffic", url: "https://www.onlinegames.io/games/2021/unity/motorbike-traffic/index.html" },
      { name: "turbo-moto-racer-3d", url: "https://www.gamenora.com/splash/turbo-moto-racer-3d/" },
      { name: "atv-highway-traffic", url: "https://www.onlinegames.io/games/2021/unity/atv-highway-traffic/index.html" },
      { name: "traffic-tour", url: "https://traffictour.github.io/traffic-tour/" }
    ];

    // -------- Функции переключения вкладок ---------
    function setActiveButton(activeBtn) {
      [btnTv, btnRadio, btnGames].forEach(btn => {
        btn.classList.remove('active', 'recording');
        if (btn === activeBtn) btn.classList.add('active');
      });
    }

    // -------- ТВ плеер ---------

    // Отрисовать список каналов с категориями и активным выделением
    function renderTVChannels(selectedName) {
      channelsList.innerHTML = '';
      // music label
      const musicLabel = document.createElement('div');
      musicLabel.className = 'category-label music';
      musicLabel.textContent = '🎵 МУЗЫКА 🎵';
      channelsList.appendChild(musicLabel);
      musicChannels.forEach(ch => {
        const div = document.createElement('div');
        div.textContent = ch.name;
        div.className = 'channel-item' + (ch.name === selectedName ? ' active' : '');
        div.tabIndex = 0;
        div.setAttribute('role', 'button');
        div.setAttribute('aria-pressed', ch.name === selectedName);
        div.onclick = () => playTVChannel(ch);
        div.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            playTVChannel(ch);
          }
        };
        channelsList.appendChild(div);
      });

      // movie label
      const movieLabel = document.createElement('div');
      movieLabel.className = 'category-label movies';
      movieLabel.textContent = '🎬 КИНО 🎬';
      channelsList.appendChild(movieLabel);
      movieChannels.forEach(ch => {
        const div = document.createElement('div');
        div.textContent = ch.name;
        div.className = 'channel-item' + (ch.name === selectedName ? ' active' : '');
        div.tabIndex = 0;
        div.setAttribute('role', 'button');
        div.setAttribute('aria-pressed', ch.name === selectedName);
        div.onclick = () => playTVChannel(ch);
        div.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            playTVChannel(ch);
          }
        };
        channelsList.appendChild(div);
      });
    }

    // Воспроизведение IPTV потока с hls.js
    function playTVChannel(channel) {
      renderTVChannels(channel.name);
      stopRadio();
      showTvSection();

      if (recording) stopRecording();

      if (hls) {
        hls.destroy();
        hls = null;
      }
      if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(channel.url);
        hls.attachMedia(videoPlayer);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          videoPlayer.play().catch(() => {});
        });
        hls.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            console.error("HLS error", data);
          }
        });
      } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
        videoPlayer.src = channel.url;
        videoPlayer.play().catch(() => {});
      } else {
        alert('Ваш браузер не поддерживает воспроизведение HLS-потоков.');
      }
      videoPlayer.muted = false;

      // Запуск записи при воспроизведении (если надо)
      startRecordingIfNeeded();
    }

    function showTvSection() {
      tvSection.style.display = 'flex';
      radioSection.style.display = 'none';
      gamesSection.style.display = 'none';
      setActiveButton(btnTv);
    }

    // -------- Радио плеер ---------

    // Отрисовать список радио каналов
    function renderRadioChannels(selectedName) {
      radioList.innerHTML = '';
      radioChannels.forEach(ch => {
        const div = document.createElement('div');
        div.textContent = ch.name;
        div.className = 'radio-item' + (ch.name === selectedName ? ' active' : '');
        div.tabIndex = 0;
        div.setAttribute('role', 'button');
        div.setAttribute('aria-pressed', ch.name === selectedName);
        div.onclick = () => playRadio(ch);
        div.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            playRadio(ch);
          }
        };
        radioList.appendChild(div);
      });
    }

    function playRadio(channel) {
      renderRadioChannels(channel.name);
      stopTV();
      showRadioSection();

      if (recording) stopRecording();

      audioPlayer.src = channel.url;
      audioPlayer.play().catch(() => {});
    }
    function showRadioSection() {
      radioSection.style.display = 'flex';
      tvSection.style.display = 'none';
      gamesSection.style.display = 'none';
      setActiveButton(btnRadio);
    }
    function stopTV() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      videoPlayer.pause();
      videoPlayer.src = "";
    }
    function stopRadio() {
      audioPlayer.pause();
      audioPlayer.src = "";
    }

    // Запуск радио с первым каналом при загрузке
    function startRadioDefault() {
      if (radioChannels.length > 0) {
        playRadio(radioChannels[0]);
      }
    }

    // -------- Игры ---------
    function renderGamesList() {
      gamesList.innerHTML = '';
      gamesListData.forEach(game => {
        const div = document.createElement('div');
        div.textContent = game.name;
        div.className = 'game-item';
        div.tabIndex = 0;
        div.setAttribute('role', 'button');
        div.onclick = () => openGame(game.url);
        div.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openGame(game.url);
          }
        };
        gamesList.appendChild(div);
      });
    }
    btnGames.addEventListener('click', () => {
      tvSection.style.display = 'none';
      radioSection.style.display = 'none';
      gamesSection.style.display = 'flex';
      setActiveButton(btnGames);
      renderGamesList();
    });

    gamesClose.addEventListener('click', () => {
      gamesSection.style.display = 'none';
      setActiveButton(null);
    });

    // ---------- Окно игры ----------

    function openGame(url) {
      gamesSection.style.display = 'none';
      gameIframe.src = url;
      gameWindow.style.display = 'flex';
      gameOverlay.style.display = 'block';

      // Активный плеер не должен мешать, выключаем ТВ и радио
      stopTV();
      stopRadio();
      setActiveButton(null);
    }

    // Закрыть окно игры
    function closeGameWindow() {
      gameIframe.src = '';
      gameWindow.style.display = 'none';
      gameOverlay.style.display = 'none';
    }

    // Минмизировать/восстановить
    gameMinimize.addEventListener('click', () => {
      gameWindow.style.transform = 'translate(-50%, 80%) scale(0.6)';
      gameWindow.style.transition = 'transform 0.3s ease';
      gameMinimize.style.display = 'none';
      gameRestore.style.display = 'inline-block';
    });
    gameRestore.addEventListener('click', () => {
      gameWindow.style.transform = 'translate(-50%, -50%) scale(1)';
      gameRestore.style.display = 'none';
      gameMinimize.style.display = 'inline-block';
    });

    // Фуллскрин
    function requestFullscreen(element) {
      if (element.requestFullscreen) element.requestFullscreen();
      else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
      else if (element.msRequestFullscreen) element.msRequestFullscreen();
    }
    function exitFullscreen() {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.msExitFullscreen) document.msExitFullscreen();
    }

    gameFullscreen.addEventListener('click', () => {
      requestFullscreen(gameWindow);
      gameFullscreen.style.display = 'none';
      gameExitFullscreen.style.display = 'inline-block';
    });
    gameExitFullscreen.addEventListener('click', () => {
      exitFullscreen();
      gameExitFullscreen.style.display = 'none';
      gameFullscreen.style.display = 'inline-block';
    });

    gameClose.addEventListener('click', closeGameWindow);
    gameOverlay.addEventListener('click', closeGameWindow);

    // ---------- Запись видео при воспроизведении IPTV (ТВ) ----------

    // переключаем кнопку ТВ в запись
    function startRecordingIfNeeded() {
      if (recording) return; // если уже записываем
      if (!videoPlayer.captureStream) return; // нет поддержки
      try {
        const stream = videoPlayer.captureStream();
        mediaRecorder = new MediaRecorder(stream);
      } catch(e) {
        console.warn("Нельзя записать видео: ", e);
        return;
      }
      recordedChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        // Автоматически скачать файл
        const a = document.createElement('a');
        a.href = url;
        a.download = "recorded-" + new Date().toISOString().replace(/:/g,"-") + ".webm";
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        recordedChunks = [];
        // Снять индикацию записи
        btnTv.classList.remove('recording');
        recording = false;
      };

      mediaRecorder.start();
      recording = true;
      btnTv.classList.add('recording');

      // Остановим через 5 секунд записи для примера (можно убрать)
      // setTimeout(stopRecording, 5000);
    }

    // Остановить запись
    function stopRecording() {
      if (mediaRecorder && recording) {
        mediaRecorder.stop();
      }
    }

    // --------- Кнопки на шапке ---------
    btnTv.addEventListener('click', () => {
      stopRadio();
      gamesSection.style.display = 'none';
      showTvSection();
      // Если нет активного канала - запускаем первый
      if (!videoPlayer.src || videoPlayer.paused) {
        playTVChannel(musicChannels[0]);
      }
    });

    btnRadio.addEventListener('click', () => {
      stopTV();
      gamesSection.style.display = 'none';
      showRadioSection();
      // Если нет запущенного радио - включаем > первый канал
      if (!audioPlayer.src || audioPlayer.paused) {
        startRadioDefault();
      }
    });

    // По умолчанию запускаем радио
    window.addEventListener('load', () => {
      btnRadio.click();
    });
  </script>
</body>
</html>
